---
sidebar_position: 1_000_000_000
tags:
  - sqlalchemy
---


# Select statement

use [`select()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.select) function

```python title= showLineNumbers
from sqlalchemy import select
stmt = select(user_table).where(user_table.c.name != "spongebob")
```
<details>

<summary> output SQL statement  </summary>

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = :name_1
```
</details>

execute select statement by
```python title= showLineNumbers
with engine.connect() as conn:
    rows = conn.execute(stmt)

    # (1, 'name1', None, 'fullname1')
    # (2, 'name2', None, 'fullname2')
```

## With ORM

when using [`select`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.select) with ORM and executing statement with [`Session.execte()`](https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.execute)

It return list of [`mappedclass`](https://docs.sqlalchemy.org/en/20/glossary.html#term-mapped) <Color color="var(--secondary-font-color)">tuple</Color>.

```python title= showLineNumbers
stmt = select(User)
with Session(engine) as conn:
    for _tuple in conn.execute(stmt):
        print(_tuple)
        print(_tuple[0])

# (User(id=1, name='11', fullname=None),)
# User(id=1, name='11', fullname=None)
# (User(id=2, name='22', fullname=None),)
# User(id=2, name='22', fullname=None)
# ...
```

<Admonition type="tip" title="tip"> 

If u <Color color="var(--secondary-font-color)">pass a single</Color> `mappedclass` to `select()`, then you can access `mappedclass` instance without having to index into tuple by using [`Session.scalars()`](https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.scalars) instead of [`Session.execute()`](https://docs.sqlalchemy.org/en/20/orm/session_api.html#sqlalchemy.orm.Session.execute)

```python title= showLineNumbers
stmt = select(User)
with Session(engine) as conn:
    for user in conn.scalars(stmt):
        print(user)

# User(id=1, name='11', fullname=None)
# User(id=2, name='22', fullname=None)
# ...
```

</Admonition>


## Specify column(s) to be selected

```python title= showLineNumbers
select(user_table)
select(User)
# SELECT user_account.id, user_account.name, user_account.fullname
# FROM user_account

select(user_table.c.name, user_table.c.fullname)
select(User.name, User.fullname)
# SELECT user_account.name, user_account.fullname
# FROM user_account
```

Passing [`Table`](https://docs.sqlalchemy.org/en/20/core/metadata.html#sqlalchemy.schema.Table) object to `select()` means select all its columns

Passing [`Column`](https://docs.sqlalchemy.org/en/20/core/metadata.html#sqlalchemy.schema.Column) object to `select()` means select specify column from its table

<Admonition type="danger" title="danger"> 

Passing different `table` into `select()` without using [`join`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.join) cause [Cartesian product](https://en.wikipedia.org/wiki/Cartesian_product) <Color color="var(--writer-additional-note-font-color)">( joining every row from one table with every row on another table )</Color>

```python title= showLineNumbers
select(User.name, Address.email_address)

# output SQL:
# highlight-start
# SELECT user_account.name, address.email_address 
# FROM user_account, address
# highlight-end
```

</Admonition>


## `SELECT...AS`

use [`ColumnElement.label()`](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.label)

```python title= showLineNumbers
stmt = select(user_table.c.name.label("foo_name"), User.fullname.label("bar_fullname"))
# SQL:
# SELECT user_account.name AS foo_name, user_account.fullname AS bar_fullname 
# FROM user_account

with Session(engine) as conn:
    results  = conn.execute(stmt)
    for row in results:
        print("name:", row.foo_name, "fullname:" , row.bar_fullname)

# name: squidward fullname: Squidward Tentacles
# name: ehkrabs fullname: Eugene H. Krabs
```

## Inject string literal into SQL

Use [`text()`](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.text) inject string literal into a SQL generated by SQLAlchemy
```python title= showLineNumbers
from sqlalchemy import text

select(text("user_account.middlename"), user_table.c.name)
# SELECT user_account.middlename, user_account.name FROM user_account

select(text("'fixed text'"), user_table.c.name)
# SELECT 'fixed text', user_account.name FROM user_account
```

### Concat string literal to column name in `SELECT`

```python title= showLineNumbers
stmt = select(("Username: " + user_table.c.name))
# SELECT 'Username: ' || user_account.name
# FROM user_account
```

## `WHERE` clause

Use Python operator, `==, !=, <, >=` etc., with [`Column`](https://docs.sqlalchemy.org/en/20/core/metadata.html#sqlalchemy.schema.Column) object inside [`Select.where()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.where) to generate `WHERE` clause

```python title= showLineNumbers
select(User.name).where(user_table.c.name == "squidward")
```

<details>

<summary> output SQL </summary>

```sql title= showLineNumbers
SELECT user_account.name
FROM user_account
WHERE user_account.name = :name_1
```

</details>

<Admonition type="info" title="info"> 

[`Select.filter_by()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.filter_by) can be used to perform equality condition

```python title= showLineNumbers
select(User).filter_by(name="spongebob", fullname="Spongebob Squarepants")
```

<details>

<summary> output SQL </summary>

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account
WHERE user_account.name = 'spongebob' AND user_account.fullname = 'Spongebob Squarepants'
```

</details>

</Admonition>

### `WHERE` with `AND`

Multiple conditions join by `AND` can be done by:
- pass multiple arguments to `where()`
- chain multiple `where()` function
- use [`and_()`](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.and_) function
- use Python `&` operator
    - &#8203;<Color color="var(--secondary-font-color)">each condition must be inside</Color> parenthesis `()` 

```python title= showLineNumbers
select(User.name).where(User.id > 2, User.id < 10)

select(User.name).where(User.id > 2).where(User.id < 10)

from sqlalchemy import and_
select(User.name).where(
    and_(User.id > 2, User.id < 10)
)

select(User.name).where(
    (User.id > 2) & (User.id < 10)
)
```

### `WHERE` with `OR`

Multiple conditions join by `OR` can be done by:
- use [`or_()`](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.or_) function
- use Python `|` operator
    - &#8203;<Color color="var(--secondary-font-color)">each condition must be inside</Color> parenthesis `()`

```python title= showLineNumbers
from sqlalchemy import or_
select(User.name).where(
    or_(User.id > 2, User.id < 10)
)

select(User.name).where(
    (User.id > 2) | (User.id < 10)
)
```

### Nested condition
```python title= showLineNumbers
select(User.name).where(
    ((User.id > 1) | (User.id < 10)) 
    & (User.id == 8)
)
```

```sql title= showLineNumbers
SELECT user_account.name 
FROM user_account 
WHERE (user_account.id > 1 OR user_account.id < 10) 
AND user_account.id = 8
```
<Admonition type="caution" title="caution"> 

If you start writing SQL statement that parenthesis and order of operator , `AND OR + - * `, matter

Read [Parentheses and Grouping](https://docs.sqlalchemy.org/en/20/core/operators.html#parentheses-and-grouping)

</Admonition>

## `JOIN`

Either use 
- [`Select.join_from()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.join_from)
- [`Select.join()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.join)

<details>

<summary> Table model for referencing example 'JOIN' code </summary>

```python title= showLineNumbers
class User(Base):
    __tablename__ = "user_account"
    id: Mapped[int] = mapped_column(primary_key=True)
    name: Mapped[str] = mapped_column(String(30))
    fullname: Mapped[str | None]
    middlename: Mapped[str | None]


class Address(Base):
    __tablename__ = "address"
    id: Mapped[int] = mapped_column(primary_key=True)
    email_address: Mapped[str]
    user_id = mapped_column(ForeignKey("user_account.id"))


class Order(Base):
    __tablename__ = "order"
    id: Mapped[int] = mapped_column(primary_key=True)
    detail: Mapped[str]
    user_id = mapped_column(ForeignKey("user_account.id"))
    user_name = mapped_column(ForeignKey("user_account.name"))
```

</details>


### `join_from()`

```python title= showLineNumbers
select(User).join_from(User, Address)
```

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname, user_account.middlename 
FROM user_account JOIN address ON user_account.id = address.user_id
```

With `join_from` you specify the `LEFT` and `RIGHT` table of the `JOIN` statement.

<Admonition type="caution" title="caution"> 

If `select()` involve table other than one specify in the `join_from` function.

They are implicitly added to `FROM` clause

```python title= showLineNumbers
select(Order).join_from(User, Address)
```

```sql title= showLineNumbers
SELECT "order".id, "order".detail, "order".user_id, "order".user_name 
# highlight-next-line
FROM "order" , 
user_account 
JOIN address 
ON user_account.id = address.user_id
```

</Admonition>

### `join()`

```python title= showLineNumbers
select(User).join(Address)
```

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname, user_account.middlename 
FROM user_account JOIN address ON user_account.id = address.user_id
```

With `join` , u only specify `RIGHT` table of the `JOIN`

<Admonition type="note" title="note"> 

If not provided, `ON` clause is automatically added based on `ForeignKey` definition define on `Table`

If two table have more than one foreignkey relationship between them, u need to explicitly set `ON` clause.
```python title= showLineNumbers
select(Order.detail).join_from(User, Order)
select(User).join(Order)

# highlight-error-start
# sqlalchemy.exc.AmbiguousForeignKeysError: 
# Can't determine join between 'user_account' and 'order'; 
# tables have more than one foreign key constraint relationship between them. 
# Please specify the 'onclause' of this join explicitly.
# highlight-error-end
```

</Admonition>

### Explicitly provide `FROM` clause

Use [`Select.select_from()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.select_from)

```python title= showLineNumbers
select(Address.email_address).select_from(User).join(Address)
```
```sql title= showLineNumbers
SELECT address.email_address 
FROM user_account JOIN address ON user_account.id = address.user_id
```

<Admonition type="tip" title="tip"> 

Use when it is not inferred the way u want. `LEFT` / `RIGHT` table

Or when `select()` does not involve any table

```python title= showLineNumbers
from sqlalchemy import func
select(func.count("*")).select_from(User)
```
```sql title= showLineNumbers
SELECT count(:count_2) AS count_1
FROM user_account
```
</Admonition>

### `ON` clause

To explicitly set `ON` clause, pass [`Column`](https://docs.sqlalchemy.org/en/20/core/metadata.html#sqlalchemy.schema.Column) with Python operator as second argument of `join`, `join_from`. just like [`WHERE`](#where-clause)

```python title= showLineNumbers
select(User).join(Address, User.id == Address.id)
select(User).join_from(User, Address, User.id == Address.id)
```
```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname, user_account.middlename 
FROM user_account JOIN address ON user_account.id = address.id
```

### `OUTER` and `FULL` join

Pass `isouter=True` or `full=True` to `join` methods

```python title= showLineNumbers
select(user_table).join(address_table, isouter=True)
```

<details>

<summary> output SQL </summary>

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account LEFT OUTER JOIN address ON user_account.id = address.user_id
```

</details>



```python title= showLineNumbers
select(user_table).join(address_table, full=True)
```

<details>

<summary> output SQL </summary>

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname
FROM user_account FULL OUTER JOIN address ON user_account.id = address.user_id
```

</details>


## `ORDER BY` clause

Use [`Select.order_by()`](https://docs.sqlalchemy.org/en/20/core/selectable.html#sqlalchemy.sql.expression.Select.order_by)

default sorting order is ASC or use [`ColumnElement.asc()`](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.asc)
```python title= showLineNumbers
select(user_table).order_by(user_table.c.name)
select(User).order_by(User.name.asc())
```

<details>

<summary> output SQL </summary>

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname, user_account.middlename 
FROM user_account ORDER BY user_account.name ASC
```

</details>

DESC sorting order use [`ColumnElement.desc()`](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.ColumnElement.desc)
```python title= showLineNumbers
select(User).order_by(User.name.desc())
```
<details>

<summary> output SQL </summary>

```sql title= showLineNumbers
SELECT user_account.id, user_account.name, user_account.fullname, user_account.middlename 
FROM user_account ORDER BY user_account.name DESC
```

</details>

<br/>

---

# Sources

- https://docs.sqlalchemy.org/en/20/tutorial/data_select.html#using-select-statements
- [https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.and_](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.and_)
- [https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.or_](https://docs.sqlalchemy.org/en/20/core/sqlelement.html#sqlalchemy.sql.expression.or_)